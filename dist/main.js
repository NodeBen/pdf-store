!function(e){var t={};function r(o){if(t[o])return t[o].exports;var n=t[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=e,r.c=t,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(o,n,function(t){return e[t]}.bind(null,n));return o},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=6)}([function(e,t){e.exports=require("mongoose")},function(e,t,r){const o=r(0);var n=new o.Schema({id:String,name:String,description:String,USD_price:Number,EUR_price:Number,file_link:String,creation_date:Date,orders_counter:Number}),s=o.model("Product",n);e.exports=s},function(e,t,r){const o=r(0),n=r(8);var s=new o.Schema({username:String,password:String,facebookId:String,googleId:String});s.methods.setPassword=function(e){this.password=n.hashSync(e,n.genSaltSync(8),null)},s.methods.verifyPassword=function(e){return n.compareSync(e,this.password)},s.methods.upgradePassword=function(){this.password&&(this.password&&0===this.password.indexOf("$2b$")||this.googleId||this.facebookId||(this.setPassword(this.password),this.save()))};var i=o.model("User",s);e.exports=i},function(e,t,r){r(0);const o=r(1),n=r(4);async function s(e){var t,r=await o.find();return await r.forEach(function(r,o){r.id==e&&(t=r)}),t}loadProducts=function(){return new Promise(function(e,t){o.find((r,o)=>{if(r)return t(r);e(o)})})},orderProductById=function(e,t){if(!t)throw"Empty id";return loadProducts().then(async r=>{var o=await s(t);if(!o)throw`Product [${t}] not found`;return o.orders_counter++,await o.save(),await n.addOrder(e,o),{successString:`Commande terminÃ©e. voici votre fichier: ${o.file_link}`,product:o}})},t.loadProducts=loadProducts,t.orderProductById=orderProductById,t.getProduct=s},function(e,t,r){r(0),r(1),r(2);const o=r(5);addOrder=function(e,t){var r=new o;r.user=e,r.product=t,r.date=new Date,r.price=t.EUR_price,r.save()},getUserProducts=async function(e){if(!e)throw"Missing user";var t=await o.find({user:e._id}).populate("product"),r=[];return t.forEach(e=>{r.push(e.product)}),r},t.addOrder=addOrder,t.getUserProducts=getUserProducts},function(e,t,r){const o=r(0);var n=o.Schema.ObjectId,s=new o.Schema({product:{type:n,ref:"Product"},user:{type:n,ref:"User"},date:Date,price:Number}),i=o.model("Order",s);e.exports=i},function(e,t,r){const o=r(7),n=r(0),s=r(3),i=r(2);n.connect("mongodb://localhost:27017/test",{useNewUrlParser:!0});r(9);getAllProducts=async function(){return new Promise(async function(e,t){(await s.loadProducts()).forEach(function(e){console.log(`${e.id} - ${e.name} / ${e.EUR_price} / ${e.orders_counter}`)}),e()})},console.log("Bienvenue. Voici les produits disponibles :"),getAllProducts().then(()=>{new Promise((e,t)=>{const r=o.createInterface({input:process.stdin,output:process.stdout});r.question("i want product [id]\n",t=>{r.close(),e(t)})}).then(async e=>{var t=e.match(/^i want product \[(.*)\]$/);if(!t)throw`Invalid command: ${e}`;var r=await i.findOne();return s.orderProductById(r,t[1])}).then(e=>{console.log(`Product Id : ${e.product.id}`),console.log(e.successString)}).catch(e=>{console.error(e)})})},function(e,t){e.exports=require("readline")},function(e,t){e.exports=require("bcrypt")},function(e,t,r){const o=r(10),n=(r(11),r(12)),s=r(13),i=r(14).Strategy,c=r(15).Strategy,u=r(16).OAuth2Strategy,a=r(17)("sk_test_SeuHn4WwG24hZiu4Xago1HzK00BHpBPB2g"),d=r(18),l=r(19),f=r(20)(l),p=r(21),g=r(22),h=o.Router(),m=(r(0),r(1)),w=r(2),y=r(5),v=r(3),b=r(4);var P=o();function S(e,t,r){if(e.isAuthenticated())return r();t.status(401).send("Login Error")}function x(e,t,r){var o={success:t,e:r};e.send(JSON.stringify(o))}P.use(r(23)()),P.use(d()),P.use(l({store:new f({}),secret:"keyboard cat",resave:!0,saveUninitialized:!0})),P.use(n.urlencoded({extended:!0})),P.use(p()),P.set("view engine","ejs"),P.use(o.static("public")),P.use(s.initialize()),P.use(s.session()),s.use(new i(function(e,t,r){w.findOne({username:e},function(e,o){return e?r(e):o?o.verifyPassword(t)?r(null,o):r(null,!1,{message:"Invalid password."}):r(null,!1,{message:"Invalid username."})})})),s.use(new c({clientID:"359928228195724",clientSecret:"ecd939fa15e1536d6b572fab2fa5d4ab",callbackURL:"http://localhost:8080/auth/facebook/callback"},async function(e,t,r,o){try{var n;if(!(n=await w.findOne({facebookId:r.id})))(n=new w).username=r.displayName,n.password=null,n.facebookId=r.id,await n.save();o(null,n)}catch(e){o(e,null)}})),s.use(new u({clientID:"844109183659-d8p5i028nerj2vo3on406u9mbtif6c1h.apps.googleusercontent.com",clientSecret:"H_FUU4OjDa5b1p5Kfvwxij6S",callbackURL:"http://localhost:8080/auth/google/callback"},async function(e,t,r,o){try{var n;if(!(n=await w.findOne({googleId:r.id})))(n=new w).username=r.displayName,n.password=null,n.googleId=r.id,await n.save();o(null,n)}catch(e){o(e,null)}})),s.serializeUser(function(e,t){t(null,e.id)}),s.deserializeUser(function(e,t){w.findById(e,function(e,r){t(e,r)})}),P.get("/",async function(e,t){var r=await v.loadProducts();t.render("pages/index",{products:r,is_auth:e.user})}),P.post("/signup/auth",function(e,t,r){s.authenticate("local",function(o,n,s){return o?r(o):n?void e.logIn(n,function(e){return e?r(e):x(t,!0,null)}):x(t,!1,s.message)})(e,t,r)}),P.get("/auth/facebook",s.authenticate("facebook")),P.get("/auth/facebook/callback",s.authenticate("facebook",{failureRedirect:"/login"}),function(e,t){t.redirect("/")}),P.get("/auth/google",s.authenticate("google",{scope:["https://www.googleapis.com/auth/plus.login"]})),P.get("/auth/google/callback",s.authenticate("google",{failureRedirect:"/login"}),function(e,t){t.redirect("/")}),P.get("/ajax/order",S,function(e,t){v.orderProductById(e.user,e.param("id")).then(e=>{let r=e.product;var o={status:!0,output:e.successString,id:r.id};t.send(JSON.stringify(o))}).catch(e=>{t.send(JSON.stringify({status:!1}))})}),P.get("/signup/login",function(e,t){t.render("pages/signup")}),P.get("/signup/logout",function(e,t){e.logout(),t.redirect("/",302)}),P.get("/getUserOrders",S,function(e,t){new Promise(function(t,r){y.find({user:e.user},(e,o)=>{e&&r("Failed to find orders"),t(o)})}).then(e=>{t.send(JSON.stringify(e))}).catch(e=>{x(t,!1,e)})}),P.get("/getUserProducts",S,async function(e,t){try{var r=await b.getUserProducts(e.user);return void t.send(JSON.stringify(r))}catch(e){return console.log(e),x(t,!1,e)}}),P.post("/charge",async function(e,t){var r=e.body.product_id,o=e.body.stripeToken,n=(e.body.stripeTokenType,e.body.stripeEmail),s=await v.getProduct(r);s?a.customers.create({email:n}).then(e=>a.customers.createSource(e.id,{source:o})).then(e=>a.charges.create({amount:100*s.EUR_price,currency:"eur",customer:e.customer})).then(e=>new Promise((t,r)=>{w.findOne({username:n},function(r,o){t({charge:e,user:o})})})).then(e=>{e.charge;var o=null;if(e.user)i=e.user;else{o=function(e){for(var t="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=0;o<e;o++)t+=r.charAt(Math.floor(Math.random()*r.length));return t}(16);var i=new w;i.username=n,i.setPassword(o),i.save()}v.orderProductById(i,r,(e,t)=>{e?console.log(e):console.log(t)}),t.render("pages/success",{product:s,user:i,pwgen:o})}).catch(e=>{console.log("err"),console.log(e),t.send("An Error occur "+e)}):t.send("Product not found")}),g.serve(h,m),P.use(h),P.listen(8080),console.log("8080 is the magic port")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("ejs")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("passport")},function(e,t){e.exports=require("passport-local")},function(e,t){e.exports=require("passport-facebook")},function(e,t){e.exports=require("passport-google-oauth")},function(e,t){e.exports=require("stripe")},function(e,t){e.exports=require("helmet")},function(e,t){e.exports=require("express-session")},function(e,t){e.exports=require("session-file-store")},function(e,t){e.exports=require("method-override")},function(e,t){e.exports=require("express-restify-mongoose")},function(e,t){e.exports=require("cookie-parser")}]);